<div class="container mx-auto p-4 md:p-8" *ngIf="!loading(); else loader">
    <!-- Header -->
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
        <div>
            <h1 class="text-3xl font-bold text-gray-800">Estado de la postulación</h1>
            <p class="text-gray-500 mt-1">{{ postulacion()?.asignaturaConvocatoria }}</p>
        </div>
        <div class="flex items-center gap-3">
            <div class="flex items-center gap-3">
                <button *ngIf="isObservada" (click)="onCorregir()"
                    class="bg-orange-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-orange-700 flex items-center gap-2 shadow-sm animate-pulse">
                    <lucide-icon name="alert-circle" class="w-4 h-4"></lucide-icon>
                    Corregir Postulación
                </button>
                <app-status-chip [status]="postulacion()?.estadoPostulacion!" type="POSTULACION"></app-status-chip>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
        <!-- Timeline -->
        <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-sm border border-gray-100">
            <h3 class="text-lg font-bold text-gray-800 mb-6">Flujo de eventos</h3>
            <div class="relative pl-4 border-l-2 border-gray-200 ml-2 space-y-8">
                <div *ngFor="let step of timelineSteps; let i = index" class="relative">
                    <div class="absolute -left-[21px] bg-white">
                        <div [ngClass]="getStepStatus(i + 1)"
                            class="w-10 h-10 rounded-full flex items-center justify-center border-2 transition-colors duration-300">
                            <ng-container [ngSwitch]="getStepStatus(i + 1)">
                                <lucide-icon *ngSwitchCase="'completed'" name="check-circle"
                                    class="w-6 h-6 text-white bg-green-600 rounded-full p-1"></lucide-icon>
                                <lucide-icon *ngSwitchCase="'current'" name="clock"
                                    class="w-6 h-6 text-green-600 bg-white border-green-600 rounded-full p-1"></lucide-icon>
                                <lucide-icon *ngSwitchCase="'error'" name="x-circle"
                                    class="w-6 h-6 text-white bg-red-600 rounded-full p-1"></lucide-icon>
                                <div *ngSwitchDefault class="w-3 h-3 bg-gray-300 rounded-full"></div>
                            </ng-container>
                        </div>
                    </div>
                    <div class="ml-6">
                        <h5 class="font-bold text-gray-800" [class.text-gray-400]="getStepStatus(i + 1) === 'pending'">
                            {{ step.title }}</h5>
                        <p class="text-sm text-gray-500">{{ step.description }}</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Side: Validations -->
        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 h-fit">
            <h3 class="text-lg font-bold text-gray-800 mb-4">Validación de requisitos</h3>
            <div class="bg-green-50 border border-green-100 rounded-lg p-4 mb-4">
                <p class="text-sm text-green-800 mb-2">Estado de la validación de los requisitos académicos</p>
                <button
                    class="w-full bg-green-700 text-white font-medium py-2 rounded-lg hover:bg-green-800 transition-colors">
                    Ver detalles
                </button>
            </div>

            <!-- Mocked other validations -->
            <div class="space-y-3">
                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                    <span class="text-sm font-medium text-gray-600">Validación de documentos</span>
                    <span class="text-xs font-semibold px-2 py-1 bg-yellow-100 text-yellow-700 rounded">En
                        revisión</span>
                </div>
                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                    <span class="text-sm font-medium text-gray-600">Validación final</span>
                    <span class="text-xs font-semibold px-2 py-1 bg-gray-100 text-gray-500 rounded">Pendiente</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Documents Section -->
    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 mb-8">
        <h3 class="text-lg font-bold text-gray-800 mb-4">Documentos de Postulación</h3>
        <div class="overflow-x-auto">
            <table class="w-full text-left border-collapse">
                <thead>
                    <tr class="text-xs text-gray-500 uppercase bg-gray-50 border-b">
                        <th class="px-4 py-3">Documento</th>
                        <th class="px-4 py-3">Estado</th>
                        <th class="px-4 py-3">Última actualización</th>
                        <th class="px-4 py-3 text-right">Acciones</th>
                    </tr>
                </thead>
                <tbody class="text-sm">
                    <!-- MOCK DATA FOR DOCUMENTS (As backend structure is simple list) -->
                    <tr class="border-b hover:bg-gray-50">
                        <td class="px-4 py-3 font-medium text-gray-800">Cédula de Identidad</td>
                        <td class="px-4 py-3">
                            <span
                                class="px-2 py-1 rounded bg-green-100 text-green-700 text-xs font-semibold">Aprobado</span>
                        </td>
                        <td class="px-4 py-3 text-gray-500">Hace 2 días</td>
                        <td class="px-4 py-3 text-right text-green-600 font-medium cursor-pointer hover:underline">
                            Ver/Descargar</td>
                    </tr>
                    <tr class="border-b hover:bg-gray-50">
                        <td class="px-4 py-3 font-medium text-gray-800">Récord Académico</td>
                        <td class="px-4 py-3">
                            <span class="px-2 py-1 rounded bg-yellow-100 text-yellow-700 text-xs font-semibold">En
                                revisión</span>
                        </td>
                        <td class="px-4 py-3 text-gray-500">Ayer</td>
                        <td class="px-4 py-3 text-right text-green-600 font-medium cursor-pointer hover:underline">
                            Ver/Descargar</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Oposición / Méritos (Results) -->
    <div *ngIf="meritos() || oposicion()" class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 mb-8">
        <h3 class="text-lg font-bold text-gray-800 mb-6">Resultados de Evaluación</h3>

        <!-- Meritos -->
        <div *ngIf="meritos()" class="mb-8">
            <h4 class="text-md font-semibold text-gray-700 mb-4 border-b pb-2">Méritos ({{ meritosTotal | number:'1.2-2'
                }} pts)</h4>
            <table class="w-full text-sm">
                <tbody class="divide-y">
                    <tr class="py-2">
                        <td class="py-2">Nota Asignatura</td>
                        <td class="py-2 text-right font-medium">{{ meritos()?.notaAsignatura }}</td>
                    </tr>
                    <tr class="py-2">
                        <td class="py-2">Nota Semestres</td>
                        <td class="py-2 text-right font-medium">{{ meritos()?.notaSemestres }}</td>
                    </tr>
                    <tr class="py-2">
                        <td class="py-2">Nota Eventos</td>
                        <td class="py-2 text-right font-medium">{{ meritos()?.notaEventos }}</td>
                    </tr>
                    <tr class="py-2">
                        <td class="py-2">Experiencia</td>
                        <td class="py-2 text-right font-medium">{{ meritos()?.notaExperiencia }}</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Oposicion -->
        <div *ngIf="oposicion()">
            <h4 class="text-md font-semibold text-gray-700 mb-4 border-b pb-2">Oposición</h4>
            <div class="bg-gray-50 p-4 rounded-lg mb-4">
                <p class="font-medium text-gray-800">Información de la prueba</p>
                <div class="grid grid-cols-2 gap-4 mt-2 text-sm text-gray-600">
                    <div>
                        <span class="block text-xs uppercase text-gray-400">Tema</span>
                        {{ oposicion()?.temaExposicion }}
                    </div>
                    <div>
                        <span class="block text-xs uppercase text-gray-400">Fecha</span>
                        {{ oposicion()?.fechaEvaluacion }}
                    </div>
                </div>
            </div>

            <!-- List individual evaluations if available -->
            <div *ngFor="let ev of oposicion()?.evaluacionesComision" class="mb-4 text-sm border-b pb-4 last:border-0">
                <p class="font-bold text-gray-700 mb-2">{{ ev.nombreCompletoUsuario }} ({{ ev.rolIntegrante }})</p>
                <div class="grid grid-cols-3 gap-2">
                    <div class="flex justify-between"><span class="text-gray-500">Material:</span> <span>{{
                            ev.puntajeMaterial }}</span></div>
                    <div class="flex justify-between"><span class="text-gray-500">Exposición:</span> <span>{{
                            ev.puntajeExposicion }}</span></div>
                    <div class="flex justify-between"><span class="text-gray-500">Preguntas:</span> <span>{{
                            ev.puntajeRespuestas }}</span></div>
                </div>
            </div>
        </div>
    </div>
</div>

<ng-template #loader>
    <div class="flex justify-center items-center h-64">
        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-green-700"></div>
    </div>
</ng-template>